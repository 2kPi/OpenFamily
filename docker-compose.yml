services:
  # Service d'initialisation pour générer le mot de passe automatiquement
  init:
    image: alpine:latest
    container_name: openfamily-init
    volumes:
      - shared_data:/shared
    command: >
      sh -c "
        if [ ! -f /shared/.db_password ]; then
            echo 'Generation automatique du mot de passe securise...'
            RANDOM_STRING=$$(tr -dc 'A-Za-z0-9' </dev/urandom | head -c 32)
            SECURE_PASSWORD=\"OF_$${RANDOM_STRING}\"
            SECURE_PASSWORD=$$(echo -n \"$$SECURE_PASSWORD\" | head -c 32)
            if [ -z \"$$SECURE_PASSWORD\" ]; then
              echo 'ERROR: password generation failed'
              exit 1
            fi
            printf '%s' \"$$SECURE_PASSWORD\" > /shared/.db_password
            echo ''
            echo '=============================================='
            echo '          MOT DE PASSE GENERE'
            echo '=============================================='
            echo ''
            echo '   IMPORTANT: NOTEZ BIEN CE MOT DE PASSE'
            echo ''
            echo \"   $$SECURE_PASSWORD\"
            echo ''
            echo '   SAUVEGARDEZ-LE MAINTENANT !'
            echo '   Necessaire pour administration'
            echo ''
            echo '=============================================='
            echo ''
            echo 'Demarrage des services dans 15 secondes...'
            sleep 15
        else
            echo 'Configuration existante detectee'
            SECURE_PASSWORD=$$(cat /shared/.db_password)
            echo \"Mot de passe: $$SECURE_PASSWORD\"
        fi
        echo 'Initialisation terminee'
      "

  # PostgreSQL Database avec mot de passe automatique
  postgres:
    image: postgres:16-alpine
    container_name: openfamily-postgres
    restart: unless-stopped
    environment:
      POSTGRES_DB: openfamily
      POSTGRES_USER: openfamily
      POSTGRES_PASSWORD_FILE: /shared/.db_password
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - shared_data:/shared:ro
      - ./server/schema.sql:/docker-entrypoint-initdb.d/01-schema.sql:ro
    ports:
      - "5433:5432"  # Port différent pour éviter conflits
    depends_on:
      init:
        condition: service_completed_successfully
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U openfamily -d openfamily"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

  # OpenFamily Application avec configuration automatique
  app:
    build: .
    container_name: openfamily-app
    restart: unless-stopped
    ports:
      - "3000:3000"
    environment:
      NODE_ENV: production
      PORT: 3000
    volumes:
      - shared_data:/shared:ro
      - app_data:/app/data
    depends_on:
      postgres:
        condition: service_healthy
    entrypoint: >
      sh -c "
        set -e
        echo 'Starting OpenFamily...'
        if [ ! -s /shared/.db_password ]; then
          echo 'ERROR: /shared/.db_password is missing or empty'
          ls -la /shared || true
          exit 1
        fi
        DB_PASSWORD=$$(head -n1 /shared/.db_password | tr -d '\r\n')
        export DATABASE_URL=\"postgresql://openfamily:$${DB_PASSWORD}@postgres:5432/openfamily\"
        echo 'DATABASE_URL configured for postgres service'
        echo 'Database configuration applied'
        exec node /app/dist/index.js
      "

volumes:
  postgres_data:
    driver: local
  app_data:
    driver: local
  shared_data:
    driver: local